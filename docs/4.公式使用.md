单据开发中经常会遇到某些字段的值是由其他几个字段计算得来，这时候我们就需要用到自动公式计算配置。
<a name="4sFBb"></a>
#### 1.编写自动计算规则代码

```java
package com.yonyou.ucf.mdf.domain.rule;

import com.alibaba.fastjson.JSONObject;
import com.yonyou.ucf.mdd.common.dto.BaseReqDto;
import com.yonyou.ucf.mdd.common.model.RuleContext;
import com.yonyou.ucf.mdd.common.model.RuleExecuteResult;
import com.yonyou.ucf.mdd.common.model.UIMetaBaseInfo;
import com.yonyou.ucf.mdd.meta.MddMetaDaoHelper;
import com.yonyou.ucf.mdd.rule.base.AbstractRule;
import org.imeta.core.model.Entity;
import org.imeta.orm.base.BizObject;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
/**
 * TODO description
 * @author leon
 * @date 2019/7/31
 * @since UCF1.0
 */

@Component("extTaxCalculateRule")//RuleID
public class ExtTaxCalculateRule extends AbstractRule {//需继承的父类

    @Override
    public <T> RuleExecuteResult execute(RuleContext ruleContext, T... ts) throws Exception {
        BaseReqDto requestParam = (BaseReqDto) ruleContext.getParamObj();
        UIMetaBaseInfo uiMeta = ruleContext.getUiMetaBaseInfo();
        JSONObject item = JSONObject.parseObject(requestParam.getItem());
        int rowIndex =0;
        if (item!= null && item.get("location") != null){
            rowIndex =
                    Integer.parseInt(item.get("location").toString() );
        }
        List<BizObject> inputFormData = getBizObjects(uiMeta, ruleContext);
        if (inputFormData != null && inputFormData.size() > 0 && inputFormData.get(0) != null
                && inputFormData.get(0).get("materielList") != null) {
            BizObject rowAsso = inputFormData.get(0);
            BizObject rowSub = ((List<BizObject>) rowAsso.get("materielList")).get(rowIndex);
            Map<String, Object> result = new HashMap<>(20);
            String fullname = rowSub.get("_entityName");
            if (!StringUtils.isEmpty(fullname)) {
                Entity entityMeta = new MddMetaDaoHelper().getEntity(fullname);
                if (entityMeta != null) {
                    entityMeta.attrMap().forEach((prop) -> result.put(prop.get("name"), null));
                }

            }

            rowSub.get("_keyName");
            rowSub.get("_status");
            for (String key : rowSub.keySet()) {
                if (!"_parent".equalsIgnoreCase(key)) {
                    result.put(key, rowSub.get(key));
                }
            }
            BigDecimal quantity = rowSub.get("quantity") == null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("quantity").toString());
            BigDecimal valuationQuantity = rowSub.get("valuationQuantity")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("valuationQuantity").toString());
            BigDecimal taxFreePrice = rowSub.get("taxFreePrice")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxFreePrice").toString());
            BigDecimal taxRate = rowSub.get("taxRate")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxRate").toString());
            BigDecimal taxPrice = rowSub.get("taxPrice")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxPrice").toString());
            BigDecimal taxFreeAmount = rowSub.get("taxFreeAmount")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxFreeAmount").toString());
            BigDecimal valueTaxTotal;
            BigDecimal taxAmount;
            BigDecimal taxFreePriceInLocal;
            BigDecimal taxPriceInLocal;
            BigDecimal taxFreeInLocal;
            BigDecimal taxInLocal;
            BigDecimal valueTaxInLocal;

            if (valuationQuantity.equals(BigDecimal.ZERO)){
                valuationQuantity= quantity;
            }

            String onChangeProp = (String) item.get("key");
            switch (onChangeProp) {

                case "taxFreeAmount":
                    taxFreePrice =valuationQuantity.equals(BigDecimal.ZERO)? taxFreeAmount :taxFreeAmount.divide(valuationQuantity);
                    break;
                case "taxPrice":
                    taxFreePrice = taxRate.equals( BigDecimal.ZERO  )? taxPrice:taxPrice.subtract( taxPrice.multiply(taxRate).divide(BigDecimal.valueOf(100)));
                    break;
                case "valueTaxTotal":
                    break;
                default:

            }
            taxPrice = taxFreePrice.multiply(taxRate.divide(BigDecimal.valueOf(100)).add(BigDecimal.ONE) );
            taxFreeAmount = valuationQuantity.multiply(taxFreePrice);
            taxAmount = valuationQuantity.multiply(taxFreePrice).multiply(taxRate).divide(BigDecimal.valueOf(100));
            valueTaxTotal = valuationQuantity.multiply(taxPrice);
            taxFreePriceInLocal = taxFreePrice;
            taxPriceInLocal = taxPrice;
            taxFreeInLocal = taxFreeAmount;
            taxInLocal = taxAmount;
            valueTaxInLocal = valueTaxTotal;

            result.put("taxPrice",taxPrice);
            result.put("taxFreeAmount",taxFreeAmount);
            result.put("taxAmount",taxAmount);
            result.put("valueTaxTotal",valueTaxTotal);
            result.put("taxFreePriceInLocal",taxFreePriceInLocal);
            result.put("taxPriceInLocal",taxPriceInLocal);
            result.put("taxFreeInLocal",taxFreeInLocal);
            result.put("taxInLocal",taxInLocal);
            result.put("valueTaxInLocal",valueTaxInLocal);


            return new RuleExecuteResult(result);
        }

        return new RuleExecuteResult("");
    }
}
```
<a name="LbCWm"></a>
#### 2.在规则表中注册规则
其中ruleID在规则定义类的注解Component中定义
```sql
INSERT INTO `billruleregister` ( `billnum`, `action`, `ruleId`, `iorder`, `overrule`, `tenant_id`, `key`, `isSystem`, `url`, `isSync`, `isAsyn`, `config` )
VALUES
	( 'common', 'check', 'extTaxCalculateRule', 50.00, NULL, '0', NULL, b '1', NULL, 0, 0, NULL );
```
<a name="Jxw4c"></a>
#### 3.主表合计公式
通过如上配置,只能让子表进行行内的计算,如果需要增加主子表的联动计算还需要在bill_itemrule表中配置主表的计算逻辑.
```sql
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxFreeAmount', '无税金额', 0, 'ucf.customer.CusQuotation', 'taxFreeAmount', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxFreeAmount]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxAmount', '税额', 0, 'ucf.customer.CusQuotation', 'taxAmount', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxAmount]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.valueTaxTotal', '税价合计', 0, 'ucf.customer.CusQuotation', 'valueTaxTotal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[valueTaxTotal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxFreeInLocal', '本币无税金额', 0, 'ucf.customer.CusQuotation', 'taxFreeInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxFreeInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-02 19:17:57', NULL, '0');
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxInLocal', '本币税额', 0, 'ucf.customer.CusQuotation', 'taxInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES ( 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.valueTaxInLocal', '本币价税合计', 0, 'ucf.customer.CusQuotation', 'valueTaxInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[valueTaxInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');

```