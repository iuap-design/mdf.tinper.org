<a name="ZnPz7"></a>
## V2.0中的重要变化
1. 拆分`yxyweb`超大集合为
  1. @mdf/cube
  1. @mdf/metaui-web
  1. @mdf/middlewares-auth
  1. @mdf/middlewares-log4js
  1. @mdf/plugin-meta
  1. @mdf/theme
2. 升级一些重要的依赖
  1. react、react-dom 升级至 ^16.9.0
  1. webpack升级至 ^4.39.2 （同时合并了 webpack 配置）
  1. babel升级至 ^7.0.0 （配置文件也从 .babelrc 换成了 babel.config.js）

**MDF2.0提供脚手架@mdf-app，可以使用该脚手架进行开发，不建议手动升级原有脚手架，这样误差较多**

<a name="1UkmU"></a>
## 1、安装依赖包
由于MDF2.0的包不开源，故发布在内网[ynpm仓库下](https://package.yonyoucloud.com/#/guide)，需要安装[ynpm-tool](https://package.yonyoucloud.com/#/guide)工具，安装如下：
> 外网可以VPN到集团内网也可以使用[ynpm](https://package.yonyoucloud.com/#/guide)


```bash
# 安装工具到全局命令cli
# 参考文档 https://package.yonyoucloud.com

npm install ynpm-tool -g
```

安装对应依赖包[(查看最新包)](https://package.yonyoucloud.com/#/)
```bash
# 使用ynpm install来安装对应的@mdf包
# 具体包如下：

  "dependencies": {
    "@mdf/cube": "^2.1.0",
    "@mdf/metaui-mobile": "^2.1.0",
    "@mdf/metaui-web": "^2.1.0",
    "@mdf/metaui-web-ncc": "^2.1.0",
    "@mdf/middlewares-auth": "^2.1.0",
    "@mdf/middlewares-log4js": "^2.1.0",
    "@mdf/plugin-meta": "^2.1.0",
    "@mdf/theme": "^2.1.0"
}
```

<a name="cpeuc"></a>
## 2、修改webapck配置
> 原有脚手架工程使用的是webpack3版本，最新MDF2.0中升级到最新的webpack4版本

MDF2.0中，webpack做了以下修改：

- 将多个配置文件合并。现在仅需要两个配置文件，webpack.dll.config.js和webpack.config.js，分别用来控制dll和应用的构建。
- 升级了webpack版本至v4，然后相应地更新配置文件，可参见官方提供的[升级文档](https://webpack.js.org/migrate/4/)，主要包括两个部分：
  - 添加mode属性，可选值为production和development
  - 一些插件现在改为内置，不再需要引入了，如uglifyjs。

因为整体配置文件差异比较大，可以以mdf-app脚手架里面的配置文件基础，将缺省的配置（图片解析）添加进来。
```javascript
var origin = [
  path.resolve('node_modules/@mdf'),
  path.resolve('src/web')
];
```
另外注意新版本中dll的文件位置有改动，以前在顶层的 manifest 文件现在在 static/scripts 中，这些也需要相应地复制一份。最简单的办法是执行一遍npm run build:dll。

<a name="YIFkC"></a>
## 3、合并package.json
package.json文件中的内部分成两个主要的部分，一是 name、version、scripts以及其它杂项，另一个是dependencies、devDependencies等依赖信息。

1. name、version、scripts应继续保留原项目信息，scripts在原有基础上调整；
1. 而dependencies、devDependencies等应基于mdf-app中的部分进行修改。

可考虑使用 [https://www.npmjs.com/package/package-json-merge](https://www.npmjs.com/package/package-json-merge) 合并dependencies部分。<br />调整scripts时，主要是对比差异进行修改。有以下几个点：

1. 各种路径有变动，比如一些目录会由原来的 src/xxx 换成 src/web/xxx
1. babel-node 中有 --only 选项，要补充上
1. build相关的命令，有的只有BABEL_ENV=production ，需要添加上 NODE_ENV=production，webpack配置文件需要这个变量。

<a name="F7Evq"></a>
## 4、修改babel.config.js
babel配置文件可以直接以脚手架中的为主，将需要的alias增加进去。<br />同时，因为现在已经切换到babel7，package.json中安装的 babel-polyfill 换成了 @babel/polyfill，或者也可以用 core-js，所以在对应的代码中，也要将 import/require babel-polyfill 的代码换成 @babel/polyfill。<br />
<a name="ViWs7"></a>
## 5、调整src下目录结构
以手机端、pc端共用一套扩建脚本，我们增加了web目录和mobile目录如果没有 手机端应用可以不增加mobile文件夹。  主要改动为：

- 去掉yxyweb，增加web目录，将bussiness提到src下。
- 并将src的components改成extends。
- 全局搜索项目中引用components的地方换成extends
- extends目录中添加 index.jsx文件，作为统一出口。可参考 mdf-app中的 common/extends/index.jsx。

原由的：                                                                改变之后的：<br />![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/192681/1567664507304-0eacfa77-429e-49b3-a0f3-71c224101ac7.png#align=left&display=inline&height=231&name=image.png&originHeight=578&originWidth=642&search=&size=42398&status=done&width=256.8)                   ![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/192681/1567664618299-ef0df0ba-f1dd-4d74-bce1-63f58d5e78dc.png#align=left&display=inline&height=338&name=image.png&originHeight=844&originWidth=584&search=&size=74654&status=done&width=233.6)

extends/index.jsx

```javascript
import * as basic from './basic'
import * as formatter from './formatter'
import * as home from './home' // home的代码中在引用 redux/modules/home，然而这个文件在web中找不到，之前应该也没引用，所以此处先注释掉
import * as meta from './meta'
import * as modal from './modal'
import * as popover from './popover'
import portal from './portal'
import * as toolbar from './toolbar'

export default {
  basic,
  formatter,
  home,
  meta,
  modal,
  popover,
  portal,
  toolbar
}

```

<a name="kglfF"></a>
## 6、删除yxyweb，替换包引用方式
  将yxyweb包删除，替换yxyweb的引用方式。以下均为项目下的全局搜索。

- 相对路径的../../../yxyweb去掉相对路径改为yxyweb
- 将yxyweb代码引用改成@mdf相关内容

| 原有路径 | 更新后路径 |
| --- | --- |
| yxyweb/common/components | @mdf/metaui-web/lib/components |
| yxyweb/common/helpers/util | @mdf/cube/lib/helpers/util |
| yxyweb/common/constants/ActionStatus | @mdf/metaui-web/lib/constants/ActionStatus |
| yxyweb/common/redux | @mdf/metaui-web/lib/redux |
| yxyweb/common/helpers/formatDate | @mdf/cube/lib/helpers/formatDate |
| yxyweb/common/helpers/env | @mdf/metaui-web/lib/helpers/env |
| yxyweb/client/common/cube | @mdf/cube/lib/cube |
| yxyweb/common/helpers/polyfill | @mdf/cube/lib/helpers/polyfill |
| yxyweb/server/middlewares/auth | @mdf/middlewares-auth |



其他替换

| 原有路径 | 更新后路径 | 备注 |
| --- | --- | --- |
| ./middlewares/log4js | @mdf/middlewares-log4js | log4js相关代码已经合并到框架中 |
| import SvgIcon from 'SvgIcon';<br />import SvgIcon from "SvgIcon"; | import SvgIcon from '@mdf/metaui-web/lib/components/common/SvgIcon' | SvgIcon走真实路径，省去babel配置（注意：yxyweb/common/components/common/SvgIconz这种引入路径） |


<a name="Xoysr"></a>
## 7、增加扩展配置文件
在common中增加三个配置文件，可以直接参考脚手架里面这三个文件。

- config.comp.js：控件、model等扩展组件属性配置。
- config.env.js： 定义环境变量地址（打印地址，服务器地址，审批地址等）。
- registerMetaComp.js：src下扩展的组件不满足需求时，可以通过这个文件扩展一些组件控件。

![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/192681/1567668108508-29246021-4695-4a91-b789-646def7cde3e.png#align=left&display=inline&height=260&name=image.png&originHeight=650&originWidth=744&search=&size=66681&status=done&width=297.6)

<a name="DK0Nw"></a>
## 8、 修改入口文件
因现在需要先加载配置文件，再加载组件，所以现在的入口文件发生了变化，在原来的基本上加了一层。

新加的一层主要用于加载 envConfig（环境配置）、compConfig（组件配置）、extendComp（扩展组件），并设置在 [@mdf/cube/lib/extend](#) 中。

setEnvConfig、setCompConfig、setExtendComp 等函数即为对应的Set方法。

它们在Set过程中，执行的是 Object.assign，所以是一次合并操作。

具体修改方式为：

1. 重命名 server/index.js 为 server/server.js，并添加新的 server/index.js文件，内容如下：

```javascript
require('@babel/polyfill')
const envConfig = require('../common/config.env').default;
const extendConfig = require('../common/config.comp').default;
const { setEnvConfig, setCompConfig, setExtendComp } = require('@mdf/cube/lib/extend')
const extendComp = require('../common/registerMetaComp').default;
const basicComponents = require('../common/extends').default
setEnvConfig(envConfig)
setCompConfig(extendConfig)
// register extend components
setExtendComp(basicComponents)
setExtendComp(extendComp)
require('./server')
```

2. 重命名 client/index.js 为 client/client.js，并添加新的 client/index.js文件，内容如下：

```javascript
require('@babel/polyfill')
const cb = require('@mdf/cube/lib/cube')
const envConfig = require('../common/config.env').default;
const extendConfig = require('../common/config.comp').default;
const { setEnvConfig, setCompConfig, setExtendComp } = require('@mdf/cube/lib/extend')
const extendComp = require('../common/registerMetaComp').default;
const basicComponents = require('../common/extends').default
extendConfig.iconfont && require('@mdf/theme/theme-ncc/font_ncc/iconfont');
setEnvConfig(envConfig)
setCompConfig(extendConfig)
// register extend components
setExtendComp(basicComponents)
setExtendComp(extendComp)

// register businessContext
const businessContext = require.context('business')
cb.registerBusinessContext(businessContext)

cb.rest.nodeEnv = process.env.NODE_ENV;

require('./client')
```

具体路径，随项目需要自行调整。
<a name="srlke"></a>
## 9、server端controller
server端相关的controller进行了代码优化，公共controller抽取。将amap、billcode、fileupload、option、processGroup、titleSetting、tpllist、files、uniform都已经抽取到公共的controller中。<br /> <br />filter相关路由
```javascript
require('yxyweb/server/controllers/filter').default(router)
```

修改为

```javascript
require('@mdf/plugin-meta/lib/router').default(router);
```

如果是ys的项目，且登录方面有问题的话，则还需要处理下meta的登录信息，需要覆盖路由。代码如下：

```javascript
const metaByBillNo = async function(ctx) {
  // if (ctx.entryPoint === 'touch') {
  //   ctx.redirect('/billing');
  //   return;
  // }
  if (ctx.store) {
    const user = await getLoginUser(ctx);
    if (!user) {
      ctx.redirect('/login');
      return;
    }
    ctx.store.dispatch({
      type: 'PLATFORM_UI_USER_INIT',
      payload: user
    });
  }
  ctx.render({
    title: ctx.params.billno
  });
}

router.get('/meta/:billtype/:billno',metaByBillNo);
router.get('/meta/:billtype/:billno/:billid', metaByBillNo);

require('@mdf/plugin-meta/lib/router').default(router);
```

<a name="GloAR"></a>
## 10、html.jsx文件配置修改

- 样式引入修改

原有内容：
```javascript
const loadCss = isDev ? '' : `<link href="${baseUrl}/styles/default/${pageInfo.entryPoint}${suffix}.css${random}" rel="stylesheet" type="text/css" />`
```
修改成：

```javascript
	const loadCss = isDev
		? `<link href="${baseUrl}/styles/ncc-theme/vendor.css${random}" rel="stylesheet" type="text/css" />`
		: `<link href="${baseUrl}/stylesheets/${pageInfo.entryPoint}${suffix}.css${random}" rel="stylesheet" type="text/css" />`;
```

- 引入antdesign的css

```javascript
<link href="//iuap-design-cdn.oss-cn-beijing.aliyuncs.com/static/antd/2.12.6/antd.css" rel="stylesheet" type="text/css" />
```

<a name="CKJtX"></a>
## 11、样式引用调整

- yxyweb样式替换

目前系统内置了一套ncc样式风格、yonsuite样式风格,只需要在package.json中文件，修改themeType 即可。<br />

1. 所有包的版本如下: 



```javascript
 "@mdf/cube": "^2.0.0",
  "@mdf/metaui-mobile": "^2.0.0",
  "@mdf/metaui-web": "^2.0.0",
  "@mdf/metaui-web-ncc": "^2.0.0",
  "@mdf/middlewares-auth": "^2.0.0",
  "@mdf/middlewares-log4js": "^1.0.0",
  "@mdf/plugin-meta": "^2.0.0",
  "@mdf/theme": "^1.0.11",
```

2. 在项目src目录下，拷贝脚手架中的src/web/client/styles/index.js文件。eg:(yonyou-mdf-framework/packages/mdf-app)目录下
2. 在 webpack.config 中加入下面代码（主要是定义__THEMETYPE__变量，以及在js/jsx的loader中添加webpack-conditional-loader）



```javascript
const package = require('./package.json')
process.env.__THEMETYPE__ = package.themeType

...
new webpack.DefinePlugin({
      ...
      'process.env.__THEMETYPE__': JSON.stringify(package.themeType),
    }),

...
[{
      test: /\.(js|jsx)$/,
      include: origin,
      exclude: /node_modules/,
      use: [{
        loader: 'babel-loader',
        query: {
          // plugins: [
          //   ["import", { "style": "css", "libraryName": "antd" }]
          // ],
          cacheDirectory: true
        }}, {
          loader: 'webpack-conditional-loader'
        }
      ],
    }
```

4. 拷贝脚手架中的这两个文件，放到项目的对应目录，无需修改.

```javascript
yonyou-mdf-framework/packages/mdf-app/src/web/common/config.comp.js
yonyou-mdf-framework/packages/mdf-app/src/web/common/registerMetaComp.js
```

6. package.json 文件修改如下代码
```javascript
  "license": "ISC",
  "themeType": "ys",   //ys、ncc 样式
  "scripts": {
   ...
  }
```

7. 完成

 


- 缺少的图片增加(可以从脚手架中把缺少的图片增加进来)

edit-mobile-bg.png 、icon-eq.png<br />![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/192681/1567672470244-940b7410-f116-4bf3-978b-7f91a4d7eb0e.png#align=left&display=inline&height=255&name=image.png&originHeight=638&originWidth=712&search=&size=58897&status=done&width=284.8)
<a name="FiAy8"></a>
## 12、 扩展脚本中import 框架包引入方式修改
现在mdf包中的代码都是es5编码，引入方式由import方式换成require

```javascript
 import env from "@mdf/metaui-web/lib/helpers/env";
```
改为

```javascript
const env = require('@mdf/metaui-web/lib/helpers/env').default;
```

可使用命令批量替换，不过要注意下检查有没有替换失败的情况。

```shell
npx replace-import-with-require src/business/**/*.js
```
<a name="1Vic2"></a>
## 13、 后端忽略 css
因目前后端和前端有一部分共用代码，所以会涉及到 import css 文件的情况，实际上不需要。

可以在后端(server/server.js)文件中添加

```javascript
import 'ignore-styles'
```
来忽略css文件。

<a name="Eg8vn"></a>
## 14、 后端Auth中间件相关配置
现在Auth中间件需要传入 envConfig。

将原来的

```javascript
.use(auth())
```

换成

```javascript
import envConfig from '../common/config.env'

.use(auth({ config: envConfig }))
```

<a name="YES2M"></a>
## 15、Business中的文件，将 import 换为 require
原有项目中经常会出现 import 与 module.exports 混用的情况。<br />根据官方文档说明，import 应与 export 结合使用，module.exports应与require结合使用，不可混合使用 import 和module.exports。<br />因为如下图所示的代码，就需要将 import 换成 require，或将 module.exports 换成 export default。<br />因为修改export会影响外部使用，所以这里只能修改 import -> require。<br />换成 _const common_product_pro = require('../PC/common_product_pro').default_ 的形式

![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/447347/1568013438984-0321016f-f418-4d87-9363-61ba29e1fc49.png#align=left&display=inline&height=232&name=image.png&originHeight=464&originWidth=798&search=&size=48011&status=done&width=399)

可使用命令批量替换，替换后需要再检查一遍。
```shell
npx replace-import-with-require src/business/**/*.js
```
<a name="whiQ5"></a>
## 16、版本号snapshot、参照修改
修改目前依赖包版本号：

```json
    "@mdf/cube": "snapshot",
    "@mdf/metaui-web": "snapshot",
    "@mdf/middlewares-auth": "snapshot",
    "@mdf/middlewares-log4js": "snapshot",
    "@mdf/plugin-meta": "snapshot",
    "@mdf/theme": "snapshot",
    "@yonyou/mdf-refer": "snapshot",
```

修改参照的引用方式：<br />新增文件mdfrefer.js，内容如下：

```javascript
//参照打包的入口文件
import '@mdf/theme/theme-default/filtercontainer';
import '@yonyou/mdf-refer/lib/support_cb';

// register businessContext
const businessContext = require.context('business');
cb.registerBusinessContext(businessContext)

```

修改参照文件，如webpack.support.withoutReact.config.js、webpack.support.withReact.config.js<br />修改入口：

```javascript
entry: { 'yxyweb-support-withoutReact': './mdfrefer.js' },
```
去掉babel-loader里面的配置插件

~~ query: {~~<br />~~       plugins: ["transform-runtime"],~~<br />~~       cacheDirectory: true~~<br />~~     }~~<br />~~<br />添加参照需要的别名：

```javascript
const webpackConfig = require('./webpack.config')
...
'business': webpackConfig.resolve.alias.business || './src/business'
```

<a name="IjyFu"></a>
# 常见问题及解决方案

1. 999 错误或404错误

一般是后端地址配置不正确，检查 config.env.js 中的地址，及原项目的地址配置方式

2. 表格高度自动变小

需要加个样式：

```css
.container-browse-mode{
  height: 100%;
}
```

3. daily环境和本地环境正常，但是test环境不正常

如果console中报 cb is not defined，基本上就是 dll 的问题，重新build一下dll，然后清除缓存强制刷新下页面试试。

4. 样式完全乱掉

一般都是antd的样式没加载出来导致的，检查下网络请求，和devtools中的styles有没有antd相关样式。

5. 如果babel-plugin-import插件失效，临时解决方案是修改src/web/server/moddlewares/viewhook/html.jsx添加CDN样式 <br />

```html
<link href="//design.yonyoucloud.com/static/antd/2.12.6/antd.css" rel="stylesheet" type="text/css" />
```