<a name="828c8229"></a>
#### 1. 数据库设计

涉及编码规则的建表语句未提供,所以需要导入建表语句;所以首先需要导入建表语句;

```sql
CREATE TABLE aa_billnumber (
  autoid INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键',
  tenant_id BIGINT(20) DEFAULT 0 COMMENT '租户',
  orgId INT(11) NOT NULL DEFAULT -1 COMMENT '组织',
  cbillnum VARCHAR(50) NOT NULL COMMENT '作为规则编码，表单模式下是表单编码，元数据模式下是元数据ID，自定义实体模式下是自定义实体主键ID',
  cbillname VARCHAR(50) NOT NULL COMMENT '表单名称',
  csubid VARCHAR(20) DEFAULT NULL,
  ballowhandwork TINYINT(4) NOT NULL COMMENT '允许手动编码',
  brepeatredo TINYINT(4) NOT NULL COMMENT '允许手工可改',
  istartnumber INT(11) NOT NULL COMMENT '流水号初始值',
  iseriallen TINYINT(4) NOT NULL COMMENT '流水号长度',
  billnumLen INT(11) NOT NULL DEFAULT 8 COMMENT '流水号长度',
  billnumInit INT(11) NOT NULL DEFAULT 1 COMMENT '流水号初始值',
  billnumTruncatType INT(11) NOT NULL DEFAULT 0 COMMENT '截断类型0 = 左截断 1 = 右截断',
  billnumFillType INT(11) NOT NULL DEFAULT 0 COMMENT '补位类型0=不补位 1=左补位 2=右补位',
  billnumFillMark VARCHAR(20) NOT NULL DEFAULT '0' COMMENT '补位符',
  billnumMode INT(11) NOT NULL DEFAULT 0 COMMENT '0=手工编号 1=自动编号 2=自动编号 手工可改',
  billnumRule INT(11) NOT NULL DEFAULT 0 COMMENT '使用规则 0 企业默认 1 自定义规则',
  isReuse TINYINT(1) DEFAULT 0 COMMENT '是否开启退号补号',
  sysid VARCHAR(40) NOT NULL COMMENT '系统ID',
  datatype TINYINT(4) NOT NULL DEFAULT 2 COMMENT '编码实体类型，1：表单，2：元数据，3：自定义实体',
  rulecode VARCHAR(100) NOT NULL COMMENT '规则编码',
  rulename VARCHAR(255) DEFAULT NULL COMMENT '规则名称',
  dr TINYINT(4) NOT NULL DEFAULT 0 COMMENT '删除标记',
  pubts TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '时间戳',
  yhtTenantId VARCHAR(20) DEFAULT NULL,
  sntype TINYINT(4) NOT NULL DEFAULT 0,
  PRIMARY KEY (autoid)
)
ENGINE = INNODB,
AUTO_INCREMENT = 47,
AVG_ROW_LENGTH = 496,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_general_ci,
COMMENT = '编码规则-主表',
ROW_FORMAT = COMPACT;
```

在`aa_billnumber`表中添加一条记录.

编码规则的设计目前是租户级的,所以要指定租户id,此处使用的租户是`gb0ucj8l`. 还需要修改`ucf_cus_order_card` 为指定excel卡片模板的名称;

```sql
INSERT INTO  `aa_billnumber`(`autoid`, `tenant_id`, `orgId`, `cbillnum`, `cbillname`, `csubid`, `ballowhandwork`, `brepeatredo`, `istartnumber`, `iseriallen`, `billnumLen`, `billnumInit`, `billnumTruncatType`, `billnumFillType`, `billnumFillMark`, `billnumMode`, `billnumRule`, `isReuse`, `sysid`, `datatype`, `rulecode`, `rulename`, `dr`, `pubts`, `yhtTenantId`, `sntype`) VALUES (48, NULL, -1, 'ucf_cus_order_card', 'mdf示例', NULL, 0, 1, 1, 8, 8, 1, 0, 1, '0', 1, 1, 0, 'diwork', 2, 'ucf_cus_order_card', NULL, 0, '2019-05-30 16:01:20', 'gb0ucj8l', 0);
```

在`billruleregister`规则注册表中增加一条编码规则的规则,`iorder`的优先级要调到优先级比较靠前;

```sql
INSERT INTO `billruleregister`(`id`, `billnum`, `action`, `ruleId`, `iorder`, `overrule`, `tenant_id`, `key`, `isSystem`, `url`, `isSync`, `isAsyn`, `config`) VALUES (1397105, 'common', 'save', 'mddUpdateBillCodeRule', 10.00, NULL, '0', NULL, b'1', NULL, 0, 0, NULL);
```

<a name="cd717346"></a>
#### 2.后台代码修改

在`ucf-mdf-bootstrap/resources/application.properties`文件中修改`billcode.cacheenable`的值为false.

在xml元数据配置的时候对需要编码的字段指定`isCode=true`.并在`realizations`标签中指定如下内容:

`<realization supplier="ucfbase.ucfbaseItf.IAutoCode" client="CusOrder"/>`

配置完成后点击保存就可以看到编码规则正常展示了.