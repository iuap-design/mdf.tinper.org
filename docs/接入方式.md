<a name="F6rLU"></a>
# 1. 场景说明
部署MDF程序的时候，如果只有一台主机的话，那么无法部署两个前端服务，想要部署多套服务的话，需要借助nginx来帮助我们实现。需要修改我们的脚手架工程来接入此特性。**注：开发环境不支持，需要生产环境才有效**<br />下面给出不同场景的对比：

```bash
# 一般场景前端URL
http://ym.yyuap.com/meta/voucher/demo_list

# 使用了上下文的前端URL
http://ym.yyuap.com/mytest/meta/voucher/demo_list
```



<a name="fJIg8"></a>
# 2. nginx配置
打开nginx.conf配置如下：

```nginx
        location /mytest/ {
            root   html;
            index  index.html index.htm;

             proxy_pass http://127.0.0.1:3003/;
        }
```

mytest 是我们的上下文的字段，proxy_pass就是我们真正的MDF地址

<a name="bmmAk"></a>
# 3. 脚手架修改

1. 修改package.json 来设置我们的PREFIX环境变量，内部读取该变量

一般来说我们部署后，npm start 执行即可
```json
"start": "cross-env NODE_ENV=production SERVER_ENV=prod PREFIX=/mytest node bin/web/server/index.js",
```

2. 修改webpack.config.js 添加需要的环境变量注入传递

```javascript
    new webpack.DefinePlugin({
      'process.env.PREFIX': JSON.stringify(process.env.PREFIX),
    })
```

3. 修改前端路由文件src/web/common/routes/index.jsx（不存在的话，找到自己项目的前端路由文件即可）

```javascript
export default (
  <Route>
    <Route path={process.env.__CLIENT__ ? (window._baseUrl || "" ) : (process.env.PREFIX || "")}>
      <Route path="menu" component={BussinessMenu} />
      <Route path="platform/:menuurl" component={DynamicView} />
      <Route path="meta">
        <Route path=":billtype/:billno" component={DynamicView} />
        <Route path=":billtype/:billno/:billid" component={DynamicView} />
      </Route>
      <Route path="*" component={ErrorNotFoundPage} />
    </Route>
  </Route>
)
```

4. 修改src/web/server/env/index.js

```javascript
const env = {
  HTTP_PREFIX: process.env.PREFIX || '',
}
...
Object.assign(env, {
  HTTP_SCRIPT_BASEURL: process.env.PREFIX || ""
})
```

5. 修改src/web/server/middlewares/viewhook/html.js 来传入使用的环境变量

```javascript
const HTTP_PREFIX = env.HTTP_PREFIX
...
<script>
  window._baseUrl = '${HTTP_PREFIX }' || ''
</script>
```