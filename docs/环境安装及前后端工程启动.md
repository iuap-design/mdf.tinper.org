[]()
<a name="054c2d8e"></a>
## 一、环境搭建


[]()
<a name="88210852"></a>
### 准备工作

1. 下载并安装JDK：版本1.8及以上，安装后需配置环境变量JAVA_HOME，参考[JAVA开发环境配置](https://www.runoob.com/java/java-environment-setup.html)
2. 下载并安装Maven：版本3.2及以上，安装后需配置用友私有仓库地址详情[见WIKI](https://wiki.yonyou.com/pages/viewpage.action?pageId=134186331)开发环境配置部分
3. 下载并安装[Git](https://git-scm.com/)：版本2.0及以上
4. 下载并安装[Eclipse](https://www.eclipse.org/downloads/)或[IDEA](http://www.jetbrains.com/)集成开发环境：版本2018及以上，并配置JDK和Maven路径
5. 下载并安装[Node.js](https://nodejs.org/en/)：版本10.0及以上


[]()
<a name="3b3f6017"></a>
## 二、后台工程启动

1.在IDE中配置jdk路径、maven路径<br />2.在GIT上clone下universal-mdf-runtime（包含doc、ucf-mdf-parent、ucf-mdf-fe三个目录）<br />3.在IDE中导入后端工程ucf-mdf-parent，或使用IDE直接导入GIT工程<br />4.新建一个mysql数据库，执行doc/scripts文件夹下的三个初始化SQL脚本<br />5.修改ucf-mdf-parent/ucf-mdf-conf工程中的配置文件mdd-db.properties，设置数据库访问链接信息

```
mdd.datasource.ds0.jdbc-url=jdbc:mysql://[dbhost]:3306/[dbname]?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true&serverTimezone=GMT%2B8
mdd.datasource.ds0.username=[username]
mdd.datasource.ds0.password=[password]
```

6.打开ucf-mdf-parent/ucf-mdf-bootstrap工程中的配置文件application.properties文件，修改注册后的工程名称，防止影响其他的注册服务。

```
#spring基本配置
spring.application.name=common-mdf
spring.domain.name=ucf-mdf-domainName
```

7.执行ucf-mdf-bootstrap项目下com.yonyou.ucf.mdf.MDFApplication类启动项目<br />PS:使用IDEA启动失败的话，需修改启动参数<br />![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/459064/1566530174205-35dc39cf-c24a-4916-a8e3-75bf009dabb5.png#align=left&display=inline&height=133&name=image.png&originHeight=126&originWidth=721&size=13323&status=done&width=758.9473779445872#align=left&display=inline&height=126&originHeight=126&originWidth=721&search=&status=done&width=721)

ucf后端项目运行依赖的mdd sdk使用说明详情见wiki:[MDD-SDK使用说明文档](https://uap.wiki.yonyou.com/pages/viewpage.action?pageId=88604942)


[]()
<a name="fb1c5a73"></a>
## 三、前端项目启动

1.cd进入ucf-mdf-fe文件夹，安装ynpm，执行install

```bash
cd ucf-mdf-fe
npm install ynpm-tool -g
ynpm install
```

2.修改hosts配置<br />服务端默认集成diwork登录，所以需要设置设置本地host文件映射一个二级域名，一级域名需与diwork一致：yyuap.com。

（1）Windows 系统：在C:\Windows\System32\drivers\etc目录下的hosts文件中增加一个域名映射：

```bash
127.0.0.1 guo.yyuap.com
```

（2）Mac 系统：

```bash
vim /etc/hosts
# 在hosts文件进行如下配置
127.0.0.1 guo.yyuap.com
```

3.启动前后端服务进行开发调试

```bash
npm run debug:client
# windows用户：打开dos窗口--->项目根目录--->npm install --->npm run debug:client
npm run debug:server
# windows用户：打开dos窗口--->项目根目录 --->npm run debug:server
```

4.登录diwork测试环境

- 访问：[http://u8c-test.yyuap.com/#/](http://u8c-test.yyuap.com/#/)
- user/password：u8c_vip[@163.com ](/163.com )     yonyou[@1988 ]()

登录成功后，即可在cookie中写入token等信息，调用hosts中映射的测试链接时才能通过验证

5.在测试环境找到对应功能节点，并拼凑可访问的 URL

```css
http://guo.yyuap.com:3003/meta/voucherlist/bd_basedocbanklist
```


[]()
<a name="f33c8d07"></a>
## 四、元数据配置

目前支持两种方式的元数据配置：<br />方式1:通过xml文件生成元数据<br />方式2为通过平台的配置页面生成元数据


[]()
<a name="3b0d980f"></a>
#### 方式1：XML方式

1.在ucf-mdf-domain/resource/meta-mpdels目录中定义元数据的xml文件<br />xml格式可参考项目中的**ucf_cus_quotation.xml**文件进行配置，文件详细说明如下：

```xml
<?xml version="1.0" encoding="utf-8"?>
<components xmlns="http://www.imeta.org/meta"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.imeta.org/meta http://upsms.yonyouup.com/meta.xsd">
    <references>
        <reference file="ucfbase.xml"/><!--引入的基础元数据文件，可以用来复用通用的属性-->
    </references>
    <!--component 组件标签，生成实体vo时相当于包路径为[moduleName.name]即:ucf.customer-->
    <!--domain 用于云端的服务挂载用,本地调试可不关注 -->
    <component name="customer" moduleName="ucf" title="客户报价单" domain="hpapaas">
        <!--主表定义，name为组件名称，可用于xml其他位置引用，tableName为生成数据库SQL时的表名-->
        <class name="CusQuotation" title="客户报价单" tableName="mdd_cus_quotation">
            <!--字段属性定义，主要属性如下：
            name：vo属性名
            columnName：数据库字段名，非持久化字段不加此属性
            title：字段名称
            iLength：字段长度
            isRequired：是否必填
            type：字段类型，基础类型有String，DateTime，Decimal(iPrecision.iScale)，Integer等，引用其他组件直接写组件包名+组件名
            -->
            <attributes>
                <attribute name="transactionType" columnName="transaction_type" type="bd.bill.TransType" title="交易类型" iLength="64" isTransactionType="true" isRequired="false"/>
                <attribute name="quotationNum" columnName="quotation_num" type="String" title="报价单号" iLength="64" isRequired="false" isCode="true"/>
                <attribute name="billDate" columnName="bill_date" type="DateTime" title="单据日期" isRequired="false"/>
                <attribute name="customerId" columnName="customer_id" type="aa.merchant.Merchant" title="客户档案ID" iLength="64" isRequired="false"/>
                <attribute name="cusContacts" columnName="cus_contacts" type="String" title="客户联系人" iLength="255" isRequired="false"/>
                <attribute name="cusContactsTel" columnName="cus_contacts_tel" type="String" title="客户联系人固定电话" iLength="255" isRequired="false"/>
                <attribute name="cusContactsMobil" columnName="cus_contacts_mobil" type="String" title="客户联系人手机号" iLength="255" isRequired="false"/>
                <attribute name="salesman" columnName="salesman_id" type="bd.staff.Staff" title="销售业务员" iLength="64" isRequired="false"/>
                <attribute name="transCurrency" columnName="trans_currency_id" type="bd.currencytenant.CurrencyTenantVO" title="交易币种" iLength="64" isRequired="false"/>
                <attribute name="localCurrency" columnName="local_currency_id" type="bd.currencytenant.CurrencyTenantVO" title="本币" iLength="64" isRequired="false"/>
                <attribute name="exchangeRate" columnName="exchange_rate" type="bd.exchangeRate.ExchangeRateVO" title="汇率" iLength="64" isRequired="false"/>
                <attribute name="taxFreeAmount" columnName="tax_free_amount" type="Decimal" title="无税金额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxAmount" columnName="tax_amount" type="Decimal" title="税额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="valueTaxTotal" columnName="value_tax_total" type="Decimal" title="价税合计" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxFreeInLocal" columnName="tax_free_in_local" type="Decimal" title="本币无税金额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxInLocal" columnName="tax_in_local" type="Decimal" title="本币税额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="valueTaxInLocal" columnName="value_tax_in_local" type="Decimal" title="本币价税合计" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="memo" columnName="memo" type="String" title="备注" iLength="255" isRequired="false"/>
                <attribute name="inquiryOrg" columnName="inquiry_org_id" type="bd.adminOrg.SalesOrgVO" title="询价组织" iLength="64" isMasterOrg="true" isRequired="false"/>
                <attribute name="inquiryDept" columnName="inquiry_dept_id" type="bd.adminOrg.AdminOrgVO" title="询价部门" iLength="64" isRequired="false"/>
                <attribute name="customerVIP" columnName="customer_vip" type="Integer" title="客户VIP属性" iLength="64" isRequired="false"/>

                <!--子表属性，没有columnName属性，不会加入建表sql，仅用于标识主子表关系-->
                <attribute name="materielList" title="询价物料列表" type="ucf.customer.CusQuotationMateriel"/>
            </attributes>
        </class>
        <!--子表 -->
        <class name="CusQuotationMateriel" title="客户报价单物料" tableName="mdd_cus_quotation_materiel">
            <attributes>
                <attribute name="materielId" columnName="materiel_id" type="aa.product.Product" title="物料ID" iLength="64" isRequired="false"/>
                <attribute name="materielNum" columnName="materiel_num" type="String" title="物料编号" iLength="64" isRequired="false"/>
                <attribute name="unitName" columnName="unit_name" type="String" title="主单位名称" iLength="64" isRequired="false"/>
                <attribute name="skuId" columnName="sku_id" type="String" title="物料SKU_ID" iLength="64" isRequired="false"/>
                <attribute name="skuNum" columnName="sku_num" type="String" title="物料SKU编号" iLength="64" isRequired="false"/>
                <attribute name="skuName" columnName="sku_name" type="String" title="物料SKU名称" iLength="64" isRequired="false"/>
                <attribute name="quantity" columnName="quantity" type="Decimal" title="数量" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="inventoryQuantity" columnName="inventory_quantity" type="Decimal" title="库存数量" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="inventoryUnit" columnName="inventory_unit" type="String" title="库存单位" iLength="64" isRequired="false"/>
                <attribute name="valuationQuantity" columnName="valuation_quantity" type="Decimal" title="计价数量" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="valuationUnit" columnName="valuation_unit" type="String" title="计价单位" iLength="64" isRequired="false"/>
                <attribute name="taxFreePrice" columnName="tax_free_price" type="Decimal" title="无税单价" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxRate" columnName="tax_rate" type="Decimal" title="税率" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxPrice" columnName="tax_price" type="Decimal" title="含税单价" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxFreeAmount" columnName="tax_free_amount" type="Decimal" title="无税金额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxAmount" columnName="tax_amount" type="Decimal" title="税额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="valueTaxTotal" columnName="value_tax_total" type="Decimal" title="价税合计" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxFreePriceInLocal" columnName="tax_free_price_in_local" type="Decimal" title="本币无税单价" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxPriceInLocal" columnName="tax_price_in_local" type="Decimal" title="本币含税单价" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxFreeInLocal" columnName="tax_free_in_local" type="Decimal" title="本币无税金额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="taxInLocal" columnName="tax_in_local" type="Decimal" title="本币税额" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="valueTaxInLocal" columnName="value_tax_in_local" type="Decimal" title="本币价税合计" iPrecision="11" iScale="6" isRequired="false"/>
                <attribute name="buyer" columnName="buyer" type="bd.staff.Staff" title="采购员/专管员" iLength="255" isRequired="false"/>
                <attribute name="memo" columnName="memo" type="String" title="备注" iLength="255" isRequired="false"/>

                <!-- 主表信息 -->
                <attribute name="cusQuotationId" columnName="cus_quotation_id" title="客户报价单主键" type="ucf.customer.CusQuotation"/>

            </attributes>
        </class>
        <!--实现的接口列表 supplier为要实现的接口，client为要实现接口的组件-->
        <realizations>
            <realization supplier="ucfbase.ucfbaseItf.IAutoCode" client="CusQuotation"/>
            <realization supplier="ucfbase.ucfbaseItf.IApprovalFlow" client="CusQuotation"/>
        </realizations>
        <!--继承的父组件列表，用来复用通用的一些属性如ID等-->
        <generalizations>
            <generalization parent="ucfbase.entity.BizObject" child="CusQuotation"/>
            <generalization parent="ucfbase.entity.BizObject" child="CusQuotationMateriel"/>
        </generalizations>
       <!--组件之间的组合关系
        type：表示对应关系类型，默认：composition
        typeB：主表组件名，roleB：从表中的主表关联属性
        typeA：从表组件名，roleA：主表中的从表关联属性
        roleAMulti：对应的表示1，1..n，n..n关联关系
        -->
        <associations>
        <association type="composition" typeB="CusQuotation" roleB="cusQuotationId" typeA="CusQuotationMateriel" roleA="materielList"
                     roleAMulti="1..n"/>
    </associations>
    </component>
</components>
```

2.生成建表SQL<br />打开ucf-mdf-tools下的TableBuildTest，修改appNames为**ucf_cus_quotation.xml**文件中**component**标签中定义的包名：

```java
String appNames = "ucf.customer";
```

执行TableBuildTest，会在ucf-mdf-conf/resources/tpl-config.properties文件中配置的目录下生成sql脚本<br />![image.png](http://design.yonyoucloud.com/static/yuque/0/2019/png/459064/1566543963242-b97ff2a8-ec4f-4530-8716-7bb1fad4fb36.png#align=left&display=inline&height=96&name=image.png&originHeight=96&originWidth=280&size=4315&status=done&width=280#align=left&display=inline&height=96&originHeight=96&originWidth=280&search=&status=done&width=280)<br />然后在数据库中执行该建表SQL脚本；


[]()
<a name="2c663367"></a>
#### 方式2：设计器方式

1. 方式2为通过平台的配置页面生成元数据，都是通过界面化的配置
2. 详细建模说明待补充


[]()
<a name="0f0e6698"></a>
## 五.模板配置

模板配置同样有两种方式：<br />方式1:通过Excel生成模板<br />方式2为通过平台的设计器页面生成模板

[]()
<a name="b47db927"></a>
#### 方式1：Excel方式

1. 因为要支持列表查询和卡片式编辑两种UI，所以需要配置两个excle文件分别用于生成列表和卡片两种UI
2. 在ucf-mdf-domain\scripts里查看列表和卡片demo文件，新建一个功能节点的页面只需要在模板Excel中更改几处即可，包括：

**cBillNo**：单据编号，要根据xml文件名进行替换，如之前定义的xml名称为ucf_cus_quotation.xml，则cBillNo需要更改为ucf_cus_quotationlist，注：**不是单个替换，需要将模板中的原cBillNo的值全部替换为ucf_cus_quotationlist**<br />**cDataSourceName**：数据源，根据xml中主表组件类名进行修改，例如ucf.customer.CusQuotation，主子表的需要在卡片模板中修改子表的数据源为xml中的子表组件类名，例如：ucf.customer.CusQuotationMateriel

3. 执行excel的宏，生成对应的UI数据sql，生成路径{excel所在目录}\UIExcel\UIExcelCreateSQL。
4. 执行scripts目录下replace.sh脚本替换租户（非必要步骤，只在租户ID为字符串时需要执行）

---


[]()
<a name="78d23dea"></a>
##### UI模板详解

1. UI模板数据表

> bill_base:UI模板数据注入口，记录模板的基础信息，如billNo，filterId，cardKey等
> billentity_base:UI包含的业务实体，可定义多个实体，通过isMain字段判断是否为主实体，dataSourceName 实体全类名
> billtemplate_base:UI模板表，用来确定模板组件的统一格式
> billtplgroup_base：模板组件Group表，用来确定包含其中的子组件的统一格式
> billitem_base：billentity_base包含实体属性列表，对应Grid或Card中的属性列，用来定义展示类型<br />
(Input,Enum,Ref)等
> pb_meta_filters：UI模板过滤器信息
> pb_filter_solution：UI模板过滤方案，支持用户自定义
> pb_filter_solution_common：pb_filter_solution过滤方案属性项，用来解释方案通过实体哪些字段过滤，如何过滤（like，=，<，>等）
> bill_toolbar：UI模板工具栏布局，如头部工具栏，底部工具栏，Grid工具栏等
> bill_toolbaritem：UI模板工具栏包含的按钮，关联bill_command
> bill_command：UI模板指令集，用来定义按钮执行的具体指令


2. 相关功能数据表

> bill_customerdef：用户自定义扩展脚本表
> bill_itemrule_*：Grid项自定义脚本，后端处理生成js文件返给前端执行，实现诸如多列求和、多列均值等操作
> bill_jointquery_*：联合查询，应用场景如bill_itemrule<br />
bill_process_*：工作流相关表，如系统已知的工作流，工作流包含的节点等<br />
bill_status_*：工作流节点状态相关表


---


[]()
<a name="49f1fac5"></a>
#### 方式2：设计器模式

使用文档<br />[https://www.yuque.com/docs/share/8c642f44-e2c7-413b-b714-4fccd041ca74](https://www.yuque.com/docs/share/8c642f44-e2c7-413b-b714-4fccd041ca74)

[]()
<a name="0170a96a"></a>
## 六、计算公式配置

单据开发中经常会遇到某些字段的值是由其他几个字段计算得来，这时候我们就需要用到自动公式计算配置。

[]()
<a name="c44d1ecc"></a>
#### 1.编写自动计算规则代码

```java
package com.yonyou.ucf.mdf.domain.rule;

import com.alibaba.fastjson.JSONObject;
import com.yonyou.ucf.mdd.common.dto.BaseReqDto;
import com.yonyou.ucf.mdd.common.model.RuleContext;
import com.yonyou.ucf.mdd.common.model.RuleExecuteResult;
import com.yonyou.ucf.mdd.common.model.UIMetaBaseInfo;
import com.yonyou.ucf.mdd.meta.MddMetaDaoHelper;
import com.yonyou.ucf.mdd.rule.base.AbstractRule;
import org.imeta.core.model.Entity;
import org.imeta.orm.base.BizObject;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
/**
 * TODO description
 * @author leon
 * @date 2019/7/31
 * @since UCF1.0
 */

@Component("extTaxCalculateRule")//RuleID
public class ExtTaxCalculateRule extends AbstractRule {//需继承的父类

    @Override
    public <T> RuleExecuteResult execute(RuleContext ruleContext, T... ts) throws Exception {
        BaseReqDto requestParam = (BaseReqDto) ruleContext.getParamObj();
        UIMetaBaseInfo uiMeta = ruleContext.getUiMetaBaseInfo();
        JSONObject item = JSONObject.parseObject(requestParam.getItem());
        int rowIndex =0;
        if (item!= null && item.get("location") != null){
            rowIndex =
                    Integer.parseInt(item.get("location").toString() );
        }
        List<BizObject> inputFormData = getBizObjects(uiMeta, ruleContext);
        if (inputFormData != null && inputFormData.size() > 0 && inputFormData.get(0) != null
                && inputFormData.get(0).get("materielList") != null) {
            BizObject rowAsso = inputFormData.get(0);
            BizObject rowSub = ((List<BizObject>) rowAsso.get("materielList")).get(rowIndex);
            Map<String, Object> result = new HashMap<>(20);
            String fullname = rowSub.get("_entityName");
            if (!StringUtils.isEmpty(fullname)) {
                Entity entityMeta = new MddMetaDaoHelper().getEntity(fullname);
                if (entityMeta != null) {
                    entityMeta.attrMap().forEach((prop) -> result.put(prop.get("name"), null));
                }

            }

            rowSub.get("_keyName");
            rowSub.get("_status");
            for (String key : rowSub.keySet()) {
                if (!"_parent".equalsIgnoreCase(key)) {
                    result.put(key, rowSub.get(key));
                }
            }
            BigDecimal quantity = rowSub.get("quantity") == null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("quantity").toString());
            BigDecimal valuationQuantity = rowSub.get("valuationQuantity")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("valuationQuantity").toString());
            BigDecimal taxFreePrice = rowSub.get("taxFreePrice")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxFreePrice").toString());
            BigDecimal taxRate = rowSub.get("taxRate")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxRate").toString());
            BigDecimal taxPrice = rowSub.get("taxPrice")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxPrice").toString());
            BigDecimal taxFreeAmount = rowSub.get("taxFreeAmount")== null ? BigDecimal.ZERO : new BigDecimal(rowSub.get("taxFreeAmount").toString());
            BigDecimal valueTaxTotal;
            BigDecimal taxAmount;
            BigDecimal taxFreePriceInLocal;
            BigDecimal taxPriceInLocal;
            BigDecimal taxFreeInLocal;
            BigDecimal taxInLocal;
            BigDecimal valueTaxInLocal;

            if (valuationQuantity.equals(BigDecimal.ZERO)){
                valuationQuantity= quantity;
            }

            String onChangeProp = (String) item.get("key");
            switch (onChangeProp) {

                case "taxFreeAmount":
                    taxFreePrice =valuationQuantity.equals(BigDecimal.ZERO)? taxFreeAmount :taxFreeAmount.divide(valuationQuantity);
                    break;
                case "taxPrice":
                    taxFreePrice = taxRate.equals( BigDecimal.ZERO  )? taxPrice:taxPrice.subtract( taxPrice.multiply(taxRate).divide(BigDecimal.valueOf(100)));
                    break;
                case "valueTaxTotal":
                    break;
                default:

            }
            taxPrice = taxFreePrice.multiply(taxRate.divide(BigDecimal.valueOf(100)).add(BigDecimal.ONE) );
            taxFreeAmount = valuationQuantity.multiply(taxFreePrice);
            taxAmount = valuationQuantity.multiply(taxFreePrice).multiply(taxRate).divide(BigDecimal.valueOf(100));
            valueTaxTotal = valuationQuantity.multiply(taxPrice);
            taxFreePriceInLocal = taxFreePrice;
            taxPriceInLocal = taxPrice;
            taxFreeInLocal = taxFreeAmount;
            taxInLocal = taxAmount;
            valueTaxInLocal = valueTaxTotal;

            result.put("taxPrice",taxPrice);
            result.put("taxFreeAmount",taxFreeAmount);
            result.put("taxAmount",taxAmount);
            result.put("valueTaxTotal",valueTaxTotal);
            result.put("taxFreePriceInLocal",taxFreePriceInLocal);
            result.put("taxPriceInLocal",taxPriceInLocal);
            result.put("taxFreeInLocal",taxFreeInLocal);
            result.put("taxInLocal",taxInLocal);
            result.put("valueTaxInLocal",valueTaxInLocal);


            return new RuleExecuteResult(result);
        }

        return new RuleExecuteResult("");
    }
}
```


[]()
<a name="8bcbaaa7"></a>
#### 2.在规则表中注册规则

其中ruleID在规则定义类的注解Component中定义

```sql
INSERT INTO `billruleregister` ( `billnum`, `action`, `ruleId`, `iorder`, `overrule`, `tenant_id`, `key`, `isSystem`, `url`, `isSync`, `isAsyn`, `config` )
VALUES
	( 'common', 'check', 'extTaxCalculateRule', 50.00, NULL, '0', NULL, b '1', NULL, 0, 0, NULL );
```


[]()
<a name="8f195ad4"></a>
#### 3.主表合计公式

插入主表合计规则公式

```sql
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (1, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxFreeAmount', '无税金额', 0, 'ucf.customer.CusQuotation', 'taxFreeAmount', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxFreeAmount]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (2, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxAmount', '税额', 0, 'ucf.customer.CusQuotation', 'taxAmount', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxAmount]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (3, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.valueTaxTotal', '税价合计', 0, 'ucf.customer.CusQuotation', 'valueTaxTotal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[valueTaxTotal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (4, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxFreeInLocal', '本币无税金额', 0, 'ucf.customer.CusQuotation', 'taxFreeInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxFreeInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-02 19:17:57', NULL, '0');
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (5, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.taxInLocal', '本币税额', 0, 'ucf.customer.CusQuotation', 'taxInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[taxInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
INSERT INTO `bill_itemrule`(`id`, `billnumber`, `ruleid`, `rulename`, `ruletype`, `entity`, `item`, `defined`, `condition`, `expression`, `triggers`, `subid`, `system`, `pubts`, `sysid`, `tenant_id`) VALUES (6, 'ucf_cus_quotation_card', 'ucf.cus_quotation_card.CusQuotation.valueTaxInLocal', '本币价税合计', 0, 'ucf.customer.CusQuotation', 'valueTaxInLocal', 0, NULL, 'sum<ucf.customer.CusQuotationMateriel>{[ucf.customer.CusQuotationMateriel].[valueTaxInLocal]*1}', '[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[valuationQuantity],[ucf.customer.CusQuotationMateriel].[taxFreePrice],[ucf.customer.CusQuotationMateriel].[taxRate],[ucf.customer.CusQuotationMateriel].[taxPrice],[ucf.customer.CusQuotationMateriel].[taxFreeAmount],[ucf.customer.CusQuotationMateriel].[taxAmount],[ucf.customer.CusQuotationMateriel].[valueTaxTotal]', 'UCF', 0, '2019-08-01 20:34:01', NULL, '0');
```


[]()
<a name="3c396438"></a>
## 七、下拉框设计

[]()
<a name="b34a1b34"></a>
#### 1. 修改数据库

示例SQL,`enumcode`, `enumname` 为下拉框的枚举值后台存储值和显示值.

```sql
INSERT INTO `aa_enum`(`id`, `enumtype`, `nametype`, `enumcode`, `localid`, `enumname`, `subid`, `pubts`, `ideleted`, `enumindex`, `icon`, `description`) VALUES (601, 'aa_booleanInt', 'text', '0', 'zh-cn', '否', 'aa', '2017-08-17 20:04:26', 0, 0, NULL, 'aa_booleanInt');
INSERT INTO `aa_enum`(`id`, `enumtype`, `nametype`, `enumcode`, `localid`, `enumname`, `subid`, `pubts`, `ideleted`, `enumindex`, `icon`, `description`) VALUES (602, 'aa_booleanInt', 'text', '1', 'zh-cn', '是', 'aa', '2017-08-17 20:04:26', 0, 1, NULL, 'aa_booleanInt');
```

[]()
<a name="0b292a2d"></a>
#### 2. 修改Excel卡片

在execel模板设计的卡片界面的`billitem_base`下,选中需要修改的字段, 是否枚举(bEnum)修改为1,控制类型(cControllType)设置为`Select`,枚举类型(cEnumType)中的内容要和数据库表中`aa_enum`中的`enumtype`字段对应.此时如果需要调整下拉框的值,就可以通过修改`aa_enum`表下对应`enumtype`的数据即可.

[]()
<a name="e00ef29f"></a>
#### 3. 修改Excel列表

列表界面需要能够成功回显表单界面的内容,需要在列表的excel中做如下操作.

修改`billitem_base`下对应的下拉框的行,修改 是否枚举(bEnum)为 `1`,枚举信息(cEnumString)为数据库配置的`enumType`,控制类型修改为`select`,枚举类型(cEnumType) 为数据库配置的`enumType`.

[]()
<a name="e90d9712"></a>
## 八、编码规则设计

[]()
<a name="828c8229"></a>
#### 1. 数据库设计

涉及编码规则的建表语句未提供,所以需要导入建表语句;所以首先需要导入建表语句;

```sql
CREATE TABLE aa_billnumber (
  autoid INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键',
  tenant_id BIGINT(20) DEFAULT 0 COMMENT '租户',
  orgId INT(11) NOT NULL DEFAULT -1 COMMENT '组织',
  cbillnum VARCHAR(50) NOT NULL COMMENT '作为规则编码，表单模式下是表单编码，元数据模式下是元数据ID，自定义实体模式下是自定义实体主键ID',
  cbillname VARCHAR(50) NOT NULL COMMENT '表单名称',
  csubid VARCHAR(20) DEFAULT NULL,
  ballowhandwork TINYINT(4) NOT NULL COMMENT '允许手动编码',
  brepeatredo TINYINT(4) NOT NULL COMMENT '允许手工可改',
  istartnumber INT(11) NOT NULL COMMENT '流水号初始值',
  iseriallen TINYINT(4) NOT NULL COMMENT '流水号长度',
  billnumLen INT(11) NOT NULL DEFAULT 8 COMMENT '流水号长度',
  billnumInit INT(11) NOT NULL DEFAULT 1 COMMENT '流水号初始值',
  billnumTruncatType INT(11) NOT NULL DEFAULT 0 COMMENT '截断类型0 = 左截断 1 = 右截断',
  billnumFillType INT(11) NOT NULL DEFAULT 0 COMMENT '补位类型0=不补位 1=左补位 2=右补位',
  billnumFillMark VARCHAR(20) NOT NULL DEFAULT '0' COMMENT '补位符',
  billnumMode INT(11) NOT NULL DEFAULT 0 COMMENT '0=手工编号 1=自动编号 2=自动编号 手工可改',
  billnumRule INT(11) NOT NULL DEFAULT 0 COMMENT '使用规则 0 企业默认 1 自定义规则',
  isReuse TINYINT(1) DEFAULT 0 COMMENT '是否开启退号补号',
  sysid VARCHAR(40) NOT NULL COMMENT '系统ID',
  datatype TINYINT(4) NOT NULL DEFAULT 2 COMMENT '编码实体类型，1：表单，2：元数据，3：自定义实体',
  rulecode VARCHAR(100) NOT NULL COMMENT '规则编码',
  rulename VARCHAR(255) DEFAULT NULL COMMENT '规则名称',
  dr TINYINT(4) NOT NULL DEFAULT 0 COMMENT '删除标记',
  pubts TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '时间戳',
  yhtTenantId VARCHAR(20) DEFAULT NULL,
  sntype TINYINT(4) NOT NULL DEFAULT 0,
  PRIMARY KEY (autoid)
)
ENGINE = INNODB,
AUTO_INCREMENT = 47,
AVG_ROW_LENGTH = 496,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_general_ci,
COMMENT = '编码规则-主表',
ROW_FORMAT = COMPACT;
```

在`aa_billnumber`表中添加一条记录.

编码规则的设计目前是租户级的,所以要指定租户id,此处使用的租户是`gb0ucj8l`. 还需要修改`ucf_cus_order_card` 为指定excel卡片模板的名称;

```sql
INSERT INTO  `aa_billnumber`(`autoid`, `tenant_id`, `orgId`, `cbillnum`, `cbillname`, `csubid`, `ballowhandwork`, `brepeatredo`, `istartnumber`, `iseriallen`, `billnumLen`, `billnumInit`, `billnumTruncatType`, `billnumFillType`, `billnumFillMark`, `billnumMode`, `billnumRule`, `isReuse`, `sysid`, `datatype`, `rulecode`, `rulename`, `dr`, `pubts`, `yhtTenantId`, `sntype`) VALUES (48, NULL, -1, 'ucf_cus_order_card', 'mdf示例', NULL, 0, 1, 1, 8, 8, 1, 0, 1, '0', 1, 1, 0, 'diwork', 2, 'ucf_cus_order_card', NULL, 0, '2019-05-30 16:01:20', 'gb0ucj8l', 0);
```

在`billruleregister`规则注册表中增加一条编码规则的规则,`iorder`的优先级要调到优先级比较靠前;

```sql
INSERT INTO `billruleregister`(`id`, `billnum`, `action`, `ruleId`, `iorder`, `overrule`, `tenant_id`, `key`, `isSystem`, `url`, `isSync`, `isAsyn`, `config`) VALUES (1397105, 'common', 'save', 'mddUpdateBillCodeRule', 10.00, NULL, '0', NULL, b'1', NULL, 0, 0, NULL);
```

[]()
<a name="cd717346"></a>
#### 2.后台代码修改

在`ucf-mdf-bootstrap/resources/application.properties`文件中修改`billcode.cacheenable`的值为false.

在xml元数据配置的时候对需要编码的字段指定`isCode=true`.并在`realizations`标签中指定如下内容:

`<realization supplier="ucfbase.ucfbaseItf.IAutoCode" client="CusOrder"/>`

配置完成后点击保存就可以看到编码规则正常展示了.

[]()
<a name="f11f5124"></a>
## 附录 MDD开发入口简介


[]()
<a name="01238575"></a>
### 1. UIMetaEngine

```
<br/> 详细介绍参照MDD SDK使用文档
 1. getMeta()

    - 功能说明：获取布局元数据，
    - 重要参数说明：
        - @NotNull ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写
        - String bIncludeViewModel, String bIncludeView <br/>//用来判断生成布局数据所使用的Loader,分别对应ViewModelLoader和ViewLoader
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

2. getTemplateList()
    - 功能说明：获取表单关联的模板列表
    - 重要参数说明：
        - String billno //表单Number
        - Integer mode //模版类型,0代表显示模版，1代表打印模版，2代表word模版
        - String terminalType //模板类型，目前主要用于指定触屏模板类型
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
3. getCommands()
    - 功能说明：获取表单定义的指令
    - 重要参数说明：
        - String billno //表单Number
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
4. getSimpleVM()
    - 功能说明：获取简单对象ViewModel，用于SQL类型参数等场景
    - 重要参数说明：
        - String billno //表单Number
        - E tplId //可以指定要获取的Template
        - Boolean isTplExport //是否用于模板导出
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
5. getCommonFilters()
    - 功能说明：查询常用过滤条件(租户级)
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

6. getSolutionList()
    - 功能说明：通过FilterId获取过滤解决方案列表
    - 重要参数说明：
        - int filterId //方案所属的Filter
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
7. getSolutionCommonList()
    - 功能说明：通过SolutionId获取通用过滤方案列表
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

8. getFilterBase()
    - 功能说明：获取过滤信息
    - 重要参数说明：
        - int filterId //方案所属的Filter
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

9. delSolution()
    - 功能说明：删除查询方案
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

10. saveSolution()
    - 功能说明：保存修改的查询方案
    - 重要参数说明
        - Map<String,Object> solutions //solution对象构造的Mapper参数
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
11. setDefaultFilter()
    - 功能说明：设置默认过滤方案
    - 重要参数说明
        - int solutionId //过滤方案ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
12. getRefMeta()
    - 功能说明：获取参照元数据
    - 重要参数说明：
        - BaseReqDto reqParam //通用的操作DTO对象
        - ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写

13. getRefData()
    - 功能说明：获取参照业务数据
    - 重要参数说明：
        - BaseReqDto reqParam //通用的操作DTO对象
        - ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写
14. getFiltersInfo()
    - 功能说明：获取过滤栏目信息
    - 重要参数说明：
        - int filterId //过滤栏目ID

15. exportExcel()
    - 功能说明：导出数据为Excel
    - 重要参数说明：
        - POIDto poiDto //数据导出操作DTO对象
16. exportTemplate()
    - 功能说明：导出当前业务数据所用模板，可以作为数据导入样例模板
    - 重要参数说明：
        - POIDto poiDto //数据导出操作DTO对象
17. importData()
    - 功能说明：通过模板导入业务数据，插入业务数据库
    - 重要参数说明：
        - MultipartFile file //数据载体文件(指定模板格式的Excel)
        - POIDto poiDto //数据导出操作DTO对象
```


[]()
<a name="7fe80b5a"></a>
### 2. RuleEngine

```
<br/> 详细介绍参照MDD SDK使用文档 
 1. execute()
    - 功能说明：规则引擎执行入口，主要包括规则列表解析，规则对象获取，规则列表执行
    - 重要参数说明：
        - RuleContext ruleContext //规则上下文，用来传递规则引擎执行过程中的必要参数<br/>
        /** 操作类型 枚举*/
        private OperationTypeEnum operateType;
        /** 字符串类型的action, 用于扩展operationType 实现OperationTypeEnum 不存在的规则action; getAction 优先取枚举类型的值，如果为空则取此字段值 */
        private String operationTypeEx;        
        /** 跨域domain 设置此值则为跨域查询，当前应用在UI元数据查询方法getMeta*/
        private String domain;
        /** 获取ruleList处理器接口的实现示例对象, 不传递默认使用DefaultRuleListHandler */
        private IRuleListHandler ruleListHandler;
        /** 规则链执行实例对象，不传使用DefaultExecRulesHandler */
        private IExecRulesHandler execRulesHandler;
        /** 规则list 排序比较器, 不传递默认使用DefaultRulesOrderCompartor */
        private IRulesOrderCompartor rulesOrderCompartor;
        /** 异步执行时候成功 */
        private boolean isMakeup = false;
        /** 租户ID */
        private T tenantId = (T) "0";
        /** 用户ID */
        private E userId;
        /** 用户名，主要用来插入创建人(修改人)信息 */
        private String userName;
        /** 规则等级：低->高： 拼接过滤条件形如 [ruleLv]_[action] ;例如 当前营销云版本应构造此参数为{"common","[subId]","[billnum]"} */
        private String[] ruleLvs;
        /** 规则关键字： 用于根据此关键字过滤规则列表; 过滤规则注册表key 字段 */
        private String ruleKey4Filter;        
        /** UI 元数据元素可见控制 过滤参数 */
        private ViewControlParams viewControlParams;
        /** UI 元数据基本信息 来源表bill_base & bill_entity */
        private UIMetaBaseInfo uiMetaBaseInfo;
        /** 自定义参数--map 方式 */
        private Map<String, Object> customMap;
        /** 自定义参数-- 泛型方式 */
        private T paramObj;
```