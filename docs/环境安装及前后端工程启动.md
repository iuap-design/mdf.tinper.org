<a name="054c2d8e"></a>
## 一、环境搭建

<a name="73de2120"></a>
### 准备工作（首先在git上clone下后端工程ucf-mdf-parent）

1. 下载并安装JDK：版本1.8及以上，安装后需配置环境变量JAVA_HOME
1. 下载并安装Maven：版本3.2及以上，安装后需配置用友私有仓库地址详情见附件文件settings.xml配置
1. 下载并安装Git：版本2.0及以上
1. 下载并安装Eclipse或IDEA集成开发环境：版本2018及以上，并配置JDK和Maven路径
1. 下载并安装Node.js：版本10.0及以上

<a name="lx9UG"></a>
## 二、后台工程启动

eclipse中导入后端工程ucf-mdf-parent,该工程为springboot工程，启动ucf-mdf-bootstrap模块下的启动类即可，需要注意的是，ucf-mdf-bootstrap模块下，在application.properties文件中有rpc的配置，本地测试时尽量更改一下注册后的工程名称，防止影响其他的注册服务。

1. 引入工程前需要ide配置jdk路径、maven路径等
1. 执行ucf-mdf-bootstrap项目下com.yonyou.ucf.mdf.MDFApplication类启动项目

ucf后端项目运行依赖的mdd sdk使用说明详情见wiki:mdd sdk wiki

<a name="391731ae"></a>
## 三、前端项目启动

步骤一：拉代码并安装资源
```bash
git clone git@git.yonyou.com:yonyou-mdf/yonyou-mdf-framework.git
cd yonyou-mdf-framework/packages/mdf-app 
npm install ynpm-tool -g
ynpm install
```
步骤二：修改hosts配置

> 服务端默认集成diwork登录，需要设置设置本地host文件映射域名（一级域名与diwork一致：yyuap.com）。


（1）Windows 用户：在C:\Windows\System32\drivers\etc目录下的hosts文件中增加一个域名映射。<br />（2）Mac 用户：
```bash
vim /etc/hosts
# 在hosts文件进行如下配置
127.0.0.1 guo.yyuap.com
```

步骤三：启动前后端服务进行开发调试

```bash
npm run debug:client
# windows用户：打开dos窗口--->项目根目录--->npm install --->npm run debug:client
npm run debug:server
# windows用户：打开dos窗口--->项目根目录 --->npm run debug:server
```

步骤四：登录diwork测试环境（写入 token 等信息）

- 访问：[http://u8c-test.yyuap.com/#/](http://u8c-test.yyuap.com/#/)
- user/password：u8c_vip@163.com     yonyou@1988

步骤五：在测试环境找到对应功能节点，并拼凑可访问的 URL

```css
http://guo.yyuap.com:3003/meta/voucherlist/bd_basedocbanklist
```



<a name="c329095f"></a>
## 四、元数据及模板配置

目前支持两种方式的元数据配置；方式1为通过xml文件生成元数据 ,方式2为通过平台的配置页面生成元数据

<a name="c19ff2df"></a>
#### 方式1：

  1. 在ucf-mdf-domain/resource/meta-mpdels目录中定义元数据的xml文件，定义方式可参基础数据部门数据basedoc_base.xml、bd_project.xml文件进行配置,xml文件中详细说明如下：

<a name="basedoc_base.xml"></a>
##### basedoc_base.xml

```
<?xml version="1.0" encoding="utf-8"?>
<components xmlns="http://www.imeta.org/meta"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.imeta.org/meta http://upsms.yonyouup.com/meta.xsd">
    <references>
        <reference file="base.xml" /> ## 需要引入的元数据文件，用来复用通用的属性
    </references>
    ## component 组件标签，当前组件相当于java interface
    <component name="basedocItf" moduleName="basedoc" ## 生成实体vo时相当于包路径
        title="UCF公共接口组件">
        <interface name="BasedocITenant" title="UCF公共租户相关"> 
        ## 元数据URI = basedoc.basedocItf.BasedocITenant,用于通过URI查询元数据信息
            <attributes>
            ## 元数据属性标签，相当于java field
                <attribute name="tenant" columnName="tenantid" title="租户"
                    type="basedoc.tenant.BasedocTenant" isRequired="true" />
            </attributes>
        </interface>
    </component>
    ## component 组建标签，当前组件相当于java class
    <component name="basedocentity" moduleName="basedoc" ## 生成实体vo时相当于包路径
        title="公用基本档案实体组件">
        <class name="BasedocBizObject" title="UCF公共基类">
            <attributes>
            ## 元数据属性标签，相当于java field
                <attribute name="id" columnName="id" title="ID"
                    type="String" iLength="36" isKey="true" />
                <attribute name="pubts" columnName="pubts" title="时间戳"
                    type="DateTime" isSyncKey="true" />
                <attribute name="code" columnName="code" title="编码"
                    type="String" iLength="100" isUnique="true"/>
                <attribute name="name" columnName="name" title="名称"
                    type="String" iLength="100" />
                <attribute name="sysid" columnName="sysid" title="应用标识"
                    type="String" iLength="50" />
                <attribute name="dr" columnName="dr" title="逻辑删除标记"
                    type="Short" iLength="1" />
            </attributes>
        </class>
    </component>
</components>
```

<a name="bd_project.xml"></a>
##### bd_project.xml

```
<?xml version="1.0" encoding="utf-8"?>
<components xmlns="http://www.imeta.org/meta" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.imeta.org/meta http://upsms.yonyouup.com/meta.xsd">
    <references>
        <reference file="basedoc_base.xml" />
    </references>
    <component name="project" moduleName="bd" title="项目组件"
        domain="ucfbasedoc"## domain 用来配置组件所属领域,主子组件domain不同时查询会走跨域查询
        <class name="ProjectVO" title="项目" tableName="bd_project">
            <attributes>
                <attribute name="orgid" columnName="orgid" title="所属组织"
                    type="bd.adminorg.AdminOrgVO"  />
            </attributes>
        </class>
        <class name="ProjectClassVO" title="项目类别" tableName="bd_projectclass">
            <attributes>
                <attribute name="orgid" columnName="orgid" title="所属组织"
                    type="bd.adminorg.AdminOrgVO" />
                    ## type：组件类型（参照），String类型，基本类型，Enum类型等
            </attributes>
        </class>
        <realizations>
            ## 实现的接口列表
            <realization supplier="basedoc.basedocItf.BasedocITenant" client="ProjectVO" />
        </realizations>
        <generalizations>
            ## 集成的父组件列表
            <generalization parent="basedoc.basedocentity.BasedocBizObject"
                child="ProjectVO" />
        </generalizations>
         <associations>
            ## 组件之间的组合关系
            ## type：表示对应关系类型，默认：composition
            ##roleB：主表别名，typeB：主表，roleA：从表别名，typeA：从表
            ## roleAMulti：对应的表示1，1..n，n..n关联关系
            <association type="composition" roleB="id" typeB="ProjectVO"  typeA="ProjectVODefine"             
                    roleA="defines" roleAMulti="1"></association>
        </associations>
    </component>
</components>---
```

- <br />
  1. 执行ucf-mdf-tools下的DomainBuildTest和TableBuildTest生产元数据实体和建表SQL,需要更改appNames，改为xml中定义的。<br />



例如bd.defdocument（对应xml文件中的moduleName.name）执行DomainBuildTest会生成实体VO，执行TableBuildTest后会根据ucf-mdf-conf/resources/tpl-config.properties文件中配置信息在指定目录下生成sql脚本，然后在数据库中执行该建表sql；

<a name="9131dc31"></a>
#### 方式2：

1. 方式2为通过平台的配置页面生成元数据，都是通过界面化的配置，配置页面地址为：元数据建模页面
1. 详细建模说明待补充

<a name="a46d3f23"></a>
### 模板配置，同样有两种方式，一种是通过Excel生成，另一种是通过设计器

<a name="018f925e"></a>
##### Excel方式：

1. 在ucf-mdf-domain\scripts里查看demo文件，配置列表和卡片，原Excel中只需要更改几处即可，包括cBillNo，要根据xml文件中配置的组件名称来配置，如名称为defdocument，则cBillNo需要更改为defdocumentlist，注：不是单个替换，需要全部替换为defdocumentlist，可以再Excel中查找替换，全部替换；另外还有修改数据源cDataSourceName，该名称同样是根据xml中进行修改，例如bd.defdocument.DefdocumentVO；
1. 执行excel的宏，生成对应的UI数据sql，生成路径{excel所在目录}\UIExcel\UIExcelCreateSQL。
1. 执行scripts目录下replace.sh脚本替换租户（非必要步骤，只在租户ID为字符串时需要执行）

---

<a name="78d23dea"></a>
##### UI模板详解

1. UI模板数据表
> bill_base:UI模板数据注入口，记录模板的基础信息，如billNo，filterId，cardKey等
> 
> billentity_base:UI包含的业务实体，可定义多个实体，通过isMain字段判断是否为主实体，dataSourceName 实体全类名
> 
> 
> billtemplate_base:UI模板表，用来确定模板组件的统一格式
> 
> billtplgroup_base：模板组件Group表，用来确定包含其中的子组件的统一格式
> 
> billitem_base：billentity_base包含实体属性列表，对应Grid或Card中的属性列，用来定义展示类型
> (Input,Enum,Ref)等
> 
> pb_meta_filters：UI模板过滤器信息
> 
> pb_filter_solution：UI模板过滤方案，支持用户自定义
> 
> pb_filter_solution_common：pb_filter_solution过滤方案属性项，用来解释方案通过实体哪些字段过滤，如何过滤（like，=，<，>等）
> 
> bill_toolbar：UI模板工具栏布局，如头部工具栏，底部工具栏，Grid工具栏等
> 
> bill_toolbaritem：UI模板工具栏包含的按钮，关联bill_command
> 
> bill_command：UI模板指令集，用来定义按钮执行的具体指令

2. 相关功能数据表
> bill_customerdef：用户自定义扩展脚本表
> 
> bill_itemrule_*：Grid项自定义脚本，后端处理生成js文件返给前端执行，实现诸如多列求和、多列均值等操作
> 
> bill_jointquery_*：联合查询，应用场景如bill_itemrule
> bill_process_*：工作流相关表，如系统已知的工作流，工作流包含的节点等
> bill_status_*：工作流节点状态相关表


---

<a name="f2562c50"></a>
#### 设计器模式

1. 暂时未开放

<a name="1b22d8d7"></a>
## 三、MDD开发入口简介

<a name="01238575"></a>
### 1. UIMetaEngine

```
<br/> 详细介绍参照MDD SDK使用文档
 1. getMeta()

    - 功能说明：获取布局元数据，
    - 重要参数说明：
        - @NotNull ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写
        - String bIncludeViewModel, String bIncludeView <br/>//用来判断生成布局数据所使用的Loader,分别对应ViewModelLoader和ViewLoader
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

2. getTemplateList()
    - 功能说明：获取表单关联的模板列表
    - 重要参数说明：
        - String billno //表单Number
        - Integer mode //模版类型,0代表显示模版，1代表打印模版，2代表word模版
        - String terminalType //模板类型，目前主要用于指定触屏模板类型
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
3. getCommands()
    - 功能说明：获取表单定义的指令
    - 重要参数说明：
        - String billno //表单Number
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
4. getSimpleVM()
    - 功能说明：获取简单对象ViewModel，用于SQL类型参数等场景
    - 重要参数说明：
        - String billno //表单Number
        - E tplId //可以指定要获取的Template
        - Boolean isTplExport //是否用于模板导出
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
5. getCommonFilters()
    - 功能说明：查询常用过滤条件(租户级)
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

6. getSolutionList()
    - 功能说明：通过FilterId获取过滤解决方案列表
    - 重要参数说明：
        - int filterId //方案所属的Filter
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
7. getSolutionCommonList()
    - 功能说明：通过SolutionId获取通用过滤方案列表
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

8. getFilterBase()
    - 功能说明：获取过滤信息
    - 重要参数说明：
        - int filterId //方案所属的Filter
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

9. delSolution()
    - 功能说明：删除查询方案
    - 重要参数说明：
        - int solutionid //过滤条件所属的方案的ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求

10. saveSolution()
    - 功能说明：保存修改的查询方案
    - 重要参数说明
        - Map<String,Object> solutions //solution对象构造的Mapper参数
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
11. setDefaultFilter()
    - 功能说明：设置默认过滤方案
    - 重要参数说明
        - int solutionId //过滤方案ID
        - String domain //跨域查询元数据标识，不为null的时候根据domian发起Dubbo跨域查询请求
12. getRefMeta()
    - 功能说明：获取参照元数据
    - 重要参数说明：
        - BaseReqDto reqParam //通用的操作DTO对象
        - ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写

13. getRefData()
    - 功能说明：获取参照业务数据
    - 重要参数说明：
        - BaseReqDto reqParam //通用的操作DTO对象
        - ViewControlParams viewControlParams //布局元素可见性控制参数：只读，只写，读写
14. getFiltersInfo()
    - 功能说明：获取过滤栏目信息
    - 重要参数说明：
        - int filterId //过滤栏目ID

15. exportExcel()
    - 功能说明：导出数据为Excel
    - 重要参数说明：
        - POIDto poiDto //数据导出操作DTO对象
16. exportTemplate()
    - 功能说明：导出当前业务数据所用模板，可以作为数据导入样例模板
    - 重要参数说明：
        - POIDto poiDto //数据导出操作DTO对象
17. importData()
    - 功能说明：通过模板导入业务数据，插入业务数据库
    - 重要参数说明：
        - MultipartFile file //数据载体文件(指定模板格式的Excel)
        - POIDto poiDto //数据导出操作DTO对象
```

<a name="7fe80b5a"></a>
### 2. RuleEngine

```
<br/> 详细介绍参照MDD SDK使用文档 
 1. execute()
    - 功能说明：规则引擎执行入口，主要包括规则列表解析，规则对象获取，规则列表执行
    - 重要参数说明：
        - RuleContext ruleContext //规则上下文，用来传递规则引擎执行过程中的必要参数<br/>
        /** 操作类型 枚举*/
        private OperationTypeEnum operateType;
        /** 字符串类型的action, 用于扩展operationType 实现OperationTypeEnum 不存在的规则action; getAction 优先取枚举类型的值，如果为空则取此字段值 */
        private String operationTypeEx;        
        /** 跨域domain 设置此值则为跨域查询，当前应用在UI元数据查询方法getMeta*/
        private String domain;
        /** 获取ruleList处理器接口的实现示例对象, 不传递默认使用DefaultRuleListHandler */
        private IRuleListHandler ruleListHandler;
        /** 规则链执行实例对象，不传使用DefaultExecRulesHandler */
        private IExecRulesHandler execRulesHandler;
        /** 规则list 排序比较器, 不传递默认使用DefaultRulesOrderCompartor */
        private IRulesOrderCompartor rulesOrderCompartor;
        /** 异步执行时候成功 */
        private boolean isMakeup = false;
        /** 租户ID */
        private T tenantId = (T) "0";
        /** 用户ID */
        private E userId;
        /** 用户名，主要用来插入创建人(修改人)信息 */
        private String userName;
        /** 规则等级：低->高： 拼接过滤条件形如 [ruleLv]_[action] ;例如 当前营销云版本应构造此参数为{"common","[subId]","[billnum]"} */
        private String[] ruleLvs;
        /** 规则关键字： 用于根据此关键字过滤规则列表; 过滤规则注册表key 字段 */
        private String ruleKey4Filter;        
        /** UI 元数据元素可见控制 过滤参数 */
        private ViewControlParams viewControlParams;
        /** UI 元数据基本信息 来源表bill_base & bill_entity */
        private UIMetaBaseInfo uiMetaBaseInfo;
        /** 自定义参数--map 方式 */
        private Map<String, Object> customMap;
        /** 自定义参数-- 泛型方式 */
        private T paramObj;
```

